<!DOCTYPE html>
<html>

<head>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cmn-Hans" xml:lang="zh-cmn-Hans">
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="content-language" content="zh">
<meta name="Content-Security-Policy" content="">
<meta name="viewport" content="width=device-width initial-scale=1">

<title>Python自动化打包业务和认证平台 V2.0-Release</title>
<meta name="description" content="相关代码：@GitHub">
<meta name="keywords" content="MySQL, Linux, Python, Reading, DBA, Muisc, 阅读, 音乐, 钢琴, 文学">
<meta property="og:title" content="DBA@Robin, MySQL DBA" />
<meta property="og:type" content="Blog, Focus on Database." />
<meta property="og:url" content="http://dbarobin.com/" />
<meta property="og:image" content="http://dbarobin.com/images/wentasy.png" />

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@dbarobin">
<meta name="twitter:creator" content="@dbarobin">
<meta name="twitter:title" content="Python自动化打包业务和认证平台 V2.0-Release">
<meta name="twitter:description" content="相关代码：@GitHub">
<meta name="twitter:url" content="http://dbarobin.com/2014/12/04/python-auto-deploy-app/">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/assets/awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/assets/css/robin.css">
<link rel="stylesheet" type="text/css" href="/assets/css/fonts-open-sans.css">
<link rel="canonical" href="http://dbarobin.com/2014/12/04/python-auto-deploy-app/">
<link rel="alternate" type="application/atom+xml" title="DBA@Robin" href="http://dbarobin.com/feed.xml" />

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?385d238b95fb1e2bd25f6510cc28b7a9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<noscript>Your browser doesn't support JavaScript or you have disabled JavaScript!</noscript>

</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">DBA@Robin</a></h1>
    <h3 class="site-meta">Focus on database.</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/">GuestBook</a>
        
        
        
        <a class="page-link" href="/feed.xml">Subscribe</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Python自动化打包业务和认证平台 V2.0-Release</h1>
    <meta itemprop="keywords" content="Python,自动化部署" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#python">Python</a>&nbsp;
     
    
    and tagged
    
    <a href="/tags/#Python" title="Python">Python </a>, 
    
    <a href="/tags/#自动化部署" title="自动化部署">自动化部署 </a>
    
    
    on Dec 4, 2014. 
    <span id="container_page_counter">
      Viewd <span id="value_page_counter"></span> times.
    </span>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <p>相关代码：<a href="https://github.com/dbarobin/python-auto-deploy">@GitHub</a></p>

<p>目录</p>

<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">1.文档摘要</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">2.更新日志</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">3.版本信息</a></li>
  <li><a href="#section-3" id="markdown-toc-section-3">4.先决条件</a></li>
  <li><a href="#section-4" id="markdown-toc-section-4">5.脚本详解</a>    <ul>
      <li><a href="#section-5" id="markdown-toc-section-5">5.1 软件概要</a></li>
      <li><a href="#section-6" id="markdown-toc-section-6">5.2 脚本帮助</a></li>
      <li><a href="#section-7" id="markdown-toc-section-7">5.3 脚本概述</a></li>
      <li><a href="#section-8" id="markdown-toc-section-8">5.4 配置文件概述</a></li>
    </ul>
  </li>
  <li><a href="#section-9" id="markdown-toc-section-9">6.脚本使用</a></li>
  <li><a href="#github" id="markdown-toc-github">7.GitHub地址</a></li>
  <li><a href="#section-10" id="markdown-toc-section-10">8.项目说明</a></li>
  <li><a href="#section-11" id="markdown-toc-section-11">9.作者信息</a></li>
</ul>

<p><code>文/温国兵</code></p>

<h2 id="section">1.文档摘要</h2>

<blockquote>
  <p>Python 自动化打包业务和认证平台，本机只需执行脚本，远程即可自动部署。脚本采用Python编写，远程调用使用Fabric实现。</p>
</blockquote>

<h2 id="section-1">2.更新日志</h2>

<p>2014-11-28</p>

<blockquote>
  <p>文档版本为「1.0」，文档名为「Python自动化打包业务和认证平台 V1.0」，备注为「文档正式版，已测试通过」，By Robin。</p>
</blockquote>

<p>2014-12-04</p>

<blockquote>
  <p>文档版本为「2.0」，文档名为「Python自动化打包业务和认证平台 V2.0-Release」，备注为「文档正式版第二版，修复若干Bug」，By Robin。</p>
</blockquote>

<h2 id="section-2">3.版本信息</h2>

<p>本机 XXX：</p>

<blockquote>
  <p>系统版本：<br />
主机名：XXX<br />
IP：xxx.xxx.xxx.xxx<br />
Python：2.6.6</p>
</blockquote>

<p>远程机 XXX：</p>

<blockquote>
  <p>系统版本：XXX<br />
主机名：XXX<br />
IP：xxx.xxx.xxx.xxx<br />
Python：2.7.3<br />
JDK：1.8.25<br />
Maven：3.2.3<br />
SVN：1.6.17</p>
</blockquote>

<h2 id="section-3">4.先决条件</h2>

<p>本机安装软件：</p>

<blockquote>
  <p>Python 2.7.5</p>
</blockquote>

<p>安装包如下：</p>

<blockquote>
  <p>apt-get: python python-pip python-dev subversion subversion-tools<br />
yum: python python-pip python-devel subversion<br />
pip: fabric</p>
</blockquote>

<p>远程服务器安装软件：</p>

<blockquote>
  <p>JDK：1.8.25<br />
Maven：3.2.3<br />
SVN：1.6.17</p>
</blockquote>

<p>安装包如下：</p>

<blockquote>
  <p>dos2unix subversion subversion-tools</p>
</blockquote>

<h2 id="section-4">5.脚本详解</h2>

<h3 id="section-5">5.1 软件概要</h3>

<p>本软件包括两个目录，其中auto_deploy_app_v2为Linux版本。auto_deploy_app_windows为Windows版本。Linux版本包括两个Python脚本以及一个配置文件。Windows版本包括两个Python脚本以及两个配置文件。</p>

<p>Linux目录结构如下：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">tree auto_deploy_app_v2</code></pre></div>

<blockquote>
  <p>auto_deploy_app_v2<br />
|-- auto_deploy_app_remote.py<br />
|-- auto_deploy_app_v_final.py <br /><br />
‘-- config.conf</p>

  <p>0 directories, 3 files</p>
</blockquote>

<p>其中，「auto_deploy_app_remote.py」是主执行脚本，用于显示帮助以及调用相应函数。「auto_deploy_app_v_final.py」是核心执行脚本，实现所有的相关功能。「config.conf」是脚本的配置文件。</p>

<p>Windows版本目录结构如下：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">tree auto_deploy_app_windows</code></pre></div>

<blockquote>
  <p>auto_deploy_app_windows<br />
|-- auto_deploy_app_remote.py<br />
|-- auto_deploy_app_v_final.py <br /><br />
‘-- config.conf <br /><br />
‘-- logging.conf</p>

  <p>0 directories, 4 files</p>
</blockquote>

<p>其中，「auto_deploy_app_remote.py」是主执行脚本，用于显示帮助以及调用相应函数。「auto_deploy_app_v_final.py」是核心执行脚本，实现所有的相关功能。「config.conf」是脚本的配置文件。「logging.conf」是日志配置文件。</p>

<p>该脚本实现的功能如下：</p>

<ul>
  <li>打印帮助</li>
  <li>部署准备</li>
  <li>检出项目</li>
  <li>更新项目</li>
  <li>部署业务平台</li>
  <li>部署认证平台</li>
  <li>启动、关闭、重启业务平台</li>
  <li>启动、关闭、重启认证平台</li>
  <li>修改数据库配置</li>
</ul>

<h3 id="section-6">5.2 脚本帮助</h3>

<p>我们通过如下命令可以获得该脚本的帮助。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./auto_deploy_app_remote.py -h</code></pre></div>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Auto deploy application to the remote web server. Write in Python.
 Version 1.0. By Robin Wen. Email:dbarobinwen@gmail.com
 
 Usage auto_deploy_app.py <span class="o">[</span>-hcustrakgdwp<span class="o">]</span>
   <span class="o">[</span>-h <span class="p">|</span> --help<span class="o">]</span> Prints this <span class="nb">help </span>and usage message
   <span class="o">[</span>-p <span class="p">|</span> --deploy-prepare<span class="o">]</span> Deploy prepared. Run as root
   <span class="o">[</span>-c <span class="p">|</span> --svn-co<span class="o">]</span> Checkout the newarkstg repo via svn
   <span class="o">[</span>-u <span class="p">|</span> --svn-update<span class="o">]</span> Update the newarkstg repo via svn
   <span class="o">[</span>-s <span class="p">|</span> --shutdown-core<span class="o">]</span> Shutdown the core platform via the stop.sh scripts
   <span class="o">[</span>-t <span class="p">|</span> --startup-core<span class="o">]</span> Startup the core platform via the startup.sh scripts
   <span class="o">[</span>-r <span class="p">|</span> --restart-core<span class="o">]</span> Restart the core platform via the restart.sh scripts
   <span class="o">[</span>-a <span class="p">|</span> --shutdown-auth<span class="o">]</span> Shutdown the auth platform via the stop.sh scripts
   <span class="o">[</span>-k <span class="p">|</span> --startup-auth<span class="o">]</span> Startup the auth platform via the startup.sh scripts
   <span class="o">[</span>-g <span class="p">|</span> --restart-auth<span class="o">]</span> Restart the auth platform via the restart.sh scripts
   <span class="o">[</span>-d <span class="p">|</span> --deploy-core-platform<span class="o">]</span> Deploy core platform via mvn
   <span class="o">[</span>-w <span class="p">|</span> --deploy-auth-platform<span class="o">]</span> Deploy auth platform via mvn
   <span class="o">[</span>-x <span class="p">|</span> --update-database-setting<span class="o">]</span> Update the database setting</code></pre></div>

<p>在脚本名后加上「-h 或者 –help」表示打印帮助。<br />
同理，加上「-p | –deploy-prepare」表示部署准备，加上「-c | –svn-co」表示检出项目，加上「-u | –svn-update」表示更新项目，加上「-s | –shutdown-core」表示关闭业务平台，加上「-t | –startup-core」表示启动业务平台，加上「-r | –restart-core」表示重启业务平台，加上「-a | –shutdown-auth」表示关闭认证平台，加上「–startup-auth」表示启动认证平台，加上「-g | –restart-auth」表示重启认证平台，加上「-d | –deploy-core-platform」表示部署业务平台，加上「-w | –deploy-auth-platform」表示部署认证平台，加上[-x | –update-database-setting]表示修改数据库配置。</p>

<h3 id="section-7">5.3 脚本概述</h3>

<p>如前所述，「auto_deploy_app_remote.py」是主执行脚本，用于显示帮助以及调用相应函数。「auto_deploy_app_v_final.py」是核心执行脚本，实现所有的相关功能。核心执行脚本采用Fabric实现远程执行命令，主执行脚本再通过<code>fab -f 脚本名 任务名</code>调用相应方法。</p>

<p>主执行脚本和核心执行脚本的方法名基本一致，主执行脚本包括如下方法：main(argv)、usage()、svn_co()、svn_update()、shutdown_core()、startup_core()、restart_core()、shutdown_auth()、startup_auth()、restart_auth()、deploy_core_platform()、deploy_auth_plaform()、deploy_prepare()和updata_database_setting()。</p>

<p>核心执行脚本包括如下方法：main(argv)、usage()、svn_co()、svn_update()、shutdown_core()、startup_core()、restart_core()、shutdown_auth()、startup_auth()、restart_auth()、deploy_core_platform()、deploy_auth_platform()、deploy_prepare()、updata_database_setting()和getConfig()。</p>

<p><strong>主执行脚本：</strong></p>

<ul>
  <li>main(argv) 主函数</li>
  <li>usage() 使用说明函数</li>
  <li>svn_co() 检出项目函数</li>
  <li>svn_update() 更新项目函数</li>
  <li>shutdown_core() 关闭业务平台方法</li>
  <li>startup_core() 启动业务平台方法</li>
  <li>restart_core() 重启业务平台方法</li>
  <li>shutdown_auth() 关闭认证平台方法</li>
  <li>startup_auth() 启动认证平台方法</li>
  <li>restart_auth() 重启认证平台方法</li>
  <li>deploy_core_platform() 部署业务平台方法</li>
  <li>deploy_auth_platform() 部署认证平台方法</li>
  <li>deploy_prepare() 部署准备方法</li>
  <li>updata_database_setting() 修改数据库配置方法。</li>
</ul>

<p><strong>主执行脚本</strong></p>

<p>主执行脚本内容如下：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">#encoding:utf-8</span>
<span class="c"># Author: Robin Wen</span>
<span class="c"># Date: 11/25/2014 10:51:54</span>
<span class="c"># Desc: Auto deploy core-platform and auth to remote sever.</span>

<span class="c"># Import necessary packages.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">syslog</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span><span class="p">,</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sudo</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">hide</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.files</span> <span class="kn">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">upload_template</span>
<span class="kn">from</span> <span class="nn">fabric.colors</span> <span class="kn">import</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">red</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="n">importError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>

<span class="n">script_name</span><span class="o">=</span><span class="s">&#39;auto_deploy_app_v_final.py&#39;</span>
<span class="n">log_path</span><span class="o">=</span><span class="s">&#39;/var/logs&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-----------------------------------------------------------------------------</span>
<span class="sd">Auto deploy core-platform and auth to tomcat.</span>

<span class="sd">Use the -h or the --help flag to get a listing of options.</span>

<span class="sd">Program: Deploy application</span>
<span class="sd">Author: Robin Wen</span>
<span class="sd">Date: November 25, 2014</span>
<span class="sd">Revision: 1.0</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Main function.</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># If no arguments print usage</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">usage</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="c"># Receive the command line arguments. The execute the corresponding function.</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-h&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--help&quot;</span><span class="p">:</span>
            <span class="n">usage</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-p&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--deploy-prepare&quot;</span><span class="p">:</span>
            <span class="n">deploy_prepare</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-c&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--svn-co&quot;</span><span class="p">:</span>
            <span class="n">svn_co</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-u&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--svn-update&quot;</span><span class="p">:</span>
            <span class="n">svn_update</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-s&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--shutdown-core&quot;</span><span class="p">:</span>
            <span class="n">shutdown_core</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-t&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--startup-core&quot;</span><span class="p">:</span>
            <span class="n">startup_core</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-r&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--restart-core&quot;</span><span class="p">:</span>
            <span class="n">restart_core</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-a&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--shutdown-auth&quot;</span><span class="p">:</span>
            <span class="n">shutdown_auth</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-k&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--startup-auth&quot;</span><span class="p">:</span>
            <span class="n">startup_auth</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-g&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--restart-auth&quot;</span><span class="p">:</span>
            <span class="n">restart_auth</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-d&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--deploy-core-platform&quot;</span><span class="p">:</span>
            <span class="n">deploy_core_platform</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-w&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--deploy-auth-platform&quot;</span><span class="p">:</span>
            <span class="n">deploy_auth_platform</span><span class="p">()</span> 
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-x&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;--update-database-setting&quot;</span><span class="p">:</span>
            <span class="n">update_database_setting</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;Unsupported option! Please refer the help.&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="n">usage</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
        <span class="c"># If an error happens print the usage and exit with an error       </span>
        <span class="n">usage</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Prints out the usage for the command line.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># Usage funtion.</span>
<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot; Auto deploy application to the remote web server. Write in Python.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">]</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Version 1.0. By Robin Wen. Email:dbarobinwen@gmail.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Usage auto_deploy_app.py [-hcustrakgdwp]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-h | --help] Prints this help and usage message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-p | --deploy-prepare] Deploy prepared. Run as root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-c | --svn-co] Checkout the newarkstg repo via svn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-u | --svn-update] Update the newarkstg repo via svn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-s | --shutdown-core] Shutdown the core platform via the stop.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-t | --startup-core] Startup the core platform via the startup.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-r | --restart-core] Restart the core platform via the restart.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-a | --shutdown-auth] Shutdown the auth platform via the stop.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-k | --startup-auth] Startup the auth platform via the startup.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-g | --restart-auth] Restart the auth platform via the restart.sh scripts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-d | --deploy-core-platform] Deploy core platform via mvn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-w | --deploy-auth-platform] Deploy auth platform via mvn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  [-x | --update-database-setting] Update the database setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">message</span>

<span class="c"># Checkout the newarkstg repo via svn function.</span>
<span class="k">def</span> <span class="nf">svn_co</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Checkout the newarkstg repo via svn.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/svn_co.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/svn_co.log&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; svn_co &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/svn_co.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Checkout finished!&#39;</span><span class="p">)</span>

<span class="c"># Update the newarkstg repo via svn function.</span>
<span class="k">def</span> <span class="nf">svn_update</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update the newarkstg repo via svn.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/svn_update.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/svn_update.log&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; svn_update &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/svn_update.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update finished!&#39;</span><span class="p">)</span>

<span class="c"># Shutdown the core platform via the stop.sh scripts function.</span>
<span class="k">def</span> <span class="nf">shutdown_core</span><span class="p">():</span>
    
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the core platform via the stop.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/shutdown_core.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/shutdown_core.log&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; shutdown_core &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/shutdown_core.log 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Startup the core platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">startup_core</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the core platform via the startup.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/startup_core.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/startup_core.log&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; startup_core &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/startup_core.log &amp; 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Restart the core platform via the restart.sh scripts function.</span>
<span class="k">def</span> <span class="nf">restart_core</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform via the restart.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/restart_core.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/restart_core.log&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; restart_core &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/restart_core.log &amp; 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Shutdown the auth platform via the stop.sh scripts function.</span>
<span class="k">def</span> <span class="nf">shutdown_auth</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the auth platform via the stop.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/shutdown_auth.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/shutdown_auth.log&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; shutdown_auth &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/shutdown_auth.log 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the auth platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Startup the auth platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">startup_auth</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the auth platform via the startup.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/startup_auth.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/startup_auth.log&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; startup_auth &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/startup_auth.log &amp; 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the authplatform finished!&#39;</span><span class="p">)</span>

<span class="c"># Restart the auth platform via the restart.sh scripts function.</span>
<span class="k">def</span> <span class="nf">restart_auth</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform via the restart.sh scripts.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/restart_auth.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/restart_auth.log&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; restart_auth&gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/restart_auth.log &amp; 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Deploy core platform via mvn function.</span>
<span class="k">def</span> <span class="nf">deploy_core_platform</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy core platform via mvn.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/deploy_core_platform.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_core_platform.log&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; deploy_core_platform &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_core_platform.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Congratulations! Deploy core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Deploy auth platform via mvn.</span>
<span class="k">def</span> <span class="nf">deploy_auth_platform</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy auth platform via mvn.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/deploy_auth_platform.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_auth_platform.log&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; deploy_auth_platform &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_auth_platform.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Congratulations! Deploy auth platform finished!&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;Attention! If you want take a glance of the deploy log, contact the system administrator.&#39;</span><span class="p">)</span>

<span class="c"># Deploy prepared.</span>
<span class="k">def</span> <span class="nf">deploy_prepare</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy prepared. Run as root.&#39;</span><span class="p">)</span>
    <span class="c"># Install jdk 1.8.25.</span>
    <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;This program require jdk 1.8.25. Make sure jdk and tomcat work out before all of your operations.&#39;</span><span class="p">)</span>
    <span class="c">#Install Maven</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Install maven.&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Logs output to the &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/deploy_prepare.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;echo &#39;&#39; &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_prepare.log&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; deploy_prepare &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/deploy_prepare.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy prepared finished.&#39;</span><span class="p">)</span>

<span class="c"># Update the databae setting.</span>
<span class="k">def</span> <span class="nf">update_database_setting</span><span class="p">():</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update the database setting.&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;Logs output to the auto_deploy_app.log&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;fab -f &quot;</span><span class="o">+</span><span class="n">script_name</span><span class="o">+</span><span class="s">&quot; update_database_setting &gt; auto_deploy_app.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update the database setting finished.&#39;</span><span class="p">)</span>

<span class="c"># The entrance of program.</span>
<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></code></pre></div>

<p><strong>核心执行脚本</strong></p>

<p>方法和主执行脚本基本一致，相同的不赘述。核心执行脚本还提供getConfig()方法，用于读取配置文件。</p>

<p>核心执行脚本内容如下：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">#encoding:utf-8</span>
<span class="c"># Author: Robin Wen</span>
<span class="c"># Date: 11/25/2014 10:51:54</span>
<span class="c"># Desc: Auto deploy core and auth platform to remote server.</span>

<span class="c"># Import necessary packages.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">syslog</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span><span class="p">,</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sudo</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">hide</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.files</span> <span class="kn">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">upload_template</span>
<span class="kn">from</span> <span class="nn">fabric.colors</span> <span class="kn">import</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">red</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="n">importError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>

<span class="c"># Configuration file name.</span>
<span class="n">config_file</span><span class="o">=</span><span class="s">&#39;config.conf&#39;</span>

<span class="c"># Get configuration from the Config </span>
<span class="k">def</span> <span class="nf">getConfig</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">config_file</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

<span class="c"># Log path</span>
<span class="n">log_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;remote_log_path&quot;</span><span class="p">)</span>

<span class="c"># Remote server hosts.</span>
<span class="n">hosts</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_usr&quot;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;@&quot;</span><span class="o">+</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_ip&quot;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_port&quot;</span><span class="p">)</span>

<span class="c"># Remote server password.</span>
<span class="n">password</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_pwd&quot;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span><span class="o">=</span><span class="p">[</span><span class="n">hosts</span><span class="p">,]</span>
<span class="n">env</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

<span class="c"># Remote server ip.</span>
<span class="n">remote_ip</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_ip&quot;</span><span class="p">)</span>

<span class="c"># Remote server username.</span>
<span class="n">remote_usr</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_usr&quot;</span><span class="p">)</span>

<span class="c"># Remote server password.</span>
<span class="n">remote_pwd</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_pwd&quot;</span><span class="p">)</span>

<span class="c"># Declare multiple variables.</span>

<span class="c"># Core platform path.</span>
<span class="n">core_platform_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;core_path&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_path&quot;</span><span class="p">)</span>

<span class="c"># Core platform configuration file path.</span>
<span class="n">core_platform_config_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;core_path&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_config_path&quot;</span><span class="p">)</span>

<span class="c"># Auth platform path.</span>
<span class="n">auth_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;auth_path&quot;</span><span class="p">,</span> <span class="s">&quot;auth_path&quot;</span><span class="p">)</span>

<span class="c"># Auth platform configuration path.</span>
<span class="n">auth_platform_config_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;auth_path&quot;</span><span class="p">,</span> <span class="s">&quot;auth_platform_config_path&quot;</span><span class="p">)</span>

<span class="c"># Core platform config api path</span>
<span class="n">core_platform_config_api_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;core_path&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_config_api_path&quot;</span><span class="p">)</span>

<span class="c"># Core platform config auth path</span>
<span class="n">core_platform_config_auth_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;core_path&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_config_auth_path&quot;</span><span class="p">)</span>

<span class="c"># Auth platform configuration api path.</span>
<span class="n">auth_platform_config_api_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;auth_path&quot;</span><span class="p">,</span> <span class="s">&quot;auth_platform_config_api_path&quot;</span><span class="p">)</span>

<span class="c"># Auth platform configuration auth path.</span>
<span class="n">auth_platform_config_auth_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;auth_path&quot;</span><span class="p">,</span> <span class="s">&quot;auth_platform_config_auth_path&quot;</span><span class="p">)</span>

<span class="c"># Svn main directory of newarkstg repo.</span>
<span class="n">svn_ns_dir</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_ns_dir&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform path.</span>
<span class="n">svn_core_platform_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_path&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform target path.</span>
<span class="n">svn_core_platform_target_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_target_path&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform path config path</span>
<span class="n">svn_core_platform_config_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_config_path&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform path config auth path</span>
<span class="n">svn_core_platform_config_auth_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_config_auth_path&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform path config api path</span>
<span class="n">svn_core_platform_config_api_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_config_api_path&quot;</span><span class="p">)</span>

<span class="c"># Svn core platform dao path</span>
<span class="n">svn_core_platform_dao_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn_path&quot;</span><span class="p">,</span> <span class="s">&quot;svn_core_platform_dao_path&quot;</span><span class="p">)</span>

<span class="c"># Database address.</span>
<span class="n">db_addr</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">,</span> <span class="s">&quot;db_addr&quot;</span><span class="p">)</span>

<span class="c"># Database username.</span>
<span class="n">db_usr</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">,</span> <span class="s">&quot;db_usr&quot;</span><span class="p">)</span>

<span class="c"># Datbase password.</span>
<span class="n">db_pwd</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">,</span> <span class="s">&quot;db_pwd&quot;</span><span class="p">)</span>

<span class="c"># Database port.</span>
<span class="n">db_port</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">,</span> <span class="s">&quot;db_port&quot;</span><span class="p">)</span>

<span class="c"># SVN username.</span>
<span class="n">svn_username</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn&quot;</span><span class="p">,</span> <span class="s">&quot;svn_username&quot;</span><span class="p">)</span>

<span class="c"># SVN password.</span>
<span class="n">svn_password</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn&quot;</span><span class="p">,</span> <span class="s">&quot;svn_password&quot;</span><span class="p">)</span>

<span class="c"># SVN url.</span>
<span class="n">svn_url</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;svn&quot;</span><span class="p">,</span> <span class="s">&quot;svn_url&quot;</span><span class="p">)</span>

<span class="c"># Memcached server ip.</span>
<span class="n">memcached_ip</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;memcached&quot;</span><span class="p">,</span> <span class="s">&quot;memcached_ip&quot;</span><span class="p">)</span>

<span class="c"># Memcached server port.</span>
<span class="n">memcached_port</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;memcached&quot;</span><span class="p">,</span> <span class="s">&quot;memcached_port&quot;</span><span class="p">)</span>

<span class="c"># Local ip address. Deploy the application on the localhost by default.</span>
<span class="n">ip_addr</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;remote&quot;</span><span class="p">,</span> <span class="s">&quot;remote_ip&quot;</span><span class="p">)</span>

<span class="c"># Core platform version.</span>
<span class="n">core_version</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;core_version&quot;</span><span class="p">)</span>

<span class="c"># Api port</span>
<span class="n">api_port</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;api_port&quot;</span><span class="p">)</span>

<span class="c"># Core platform bundles path</span>
<span class="n">core_platform_bundles_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;core_path&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_bundles_path&quot;</span><span class="p">)</span>

<span class="c"># Auth platform bundles path</span>
<span class="n">auth_platform_bundles_path</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;auth_path&quot;</span><span class="p">,</span> <span class="s">&quot;auth_platform_bundles_path&quot;</span><span class="p">)</span>

<span class="c"># Core platform jar name</span>
<span class="n">core_platform_jar</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;core_platform_jar&quot;</span><span class="p">)</span>

<span class="c"># Auth platform jar name</span>
<span class="n">auth_platform_jar</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;auth_platform_jar&quot;</span><span class="p">)</span>

<span class="c"># Core jar</span>
<span class="n">core_jar</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;core_jar&quot;</span><span class="p">)</span>

<span class="c"># Auth jar</span>
<span class="n">auth_jar</span><span class="o">=</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="s">&quot;auth_jar&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-----------------------------------------------------------------------------</span>
<span class="sd">Auto deploy core-platform and auth to tomcat.</span>

<span class="sd">Use the -h or the --help flag to get a listing of options.</span>

<span class="sd">Program: Deploy application</span>
<span class="sd">Author: Robin Wen</span>
<span class="sd">Date: November 25, 2014</span>
<span class="sd">Revision: 1.0</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># Checkout the newarkstg repo via svn function.</span>
<span class="k">def</span> <span class="nf">svn_co</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Checkout the newarkstg repo via svn.&#39;</span><span class="p">)</span>
    
    <span class="c"># Create necessary directory</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">svn_ns_dir</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c">#run(&#39;ls -l &#39;+path+&#39;&#39;)</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">svn_ns_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;svn co --username &#39;</span><span class="o">+</span><span class="n">svn_username</span><span class="o">+</span><span class="s">&#39; --password &#39;</span><span class="o">+</span><span class="n">svn_password</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">svn_url</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">svn_ns_dir</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Checkout finished!&#39;</span><span class="p">)</span>

<span class="c"># Update the newarkstg repo via svn function.</span>
<span class="k">def</span> <span class="nf">svn_update</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update the newarkstg repo via svn.&#39;</span><span class="p">)</span>

    <span class="c"># Create necessary directory</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">svn_ns_dir</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">svn_ns_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;svn update --username &#39;</span><span class="o">+</span><span class="n">svn_username</span><span class="o">+</span><span class="s">&#39; --password &#39;</span><span class="o">+</span><span class="n">svn_password</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">svn_ns_dir</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Update finished!&#39;</span><span class="p">)</span>

<span class="c"># Shutdown the core platform via the stop.sh scripts function.</span>
<span class="k">def</span> <span class="nf">shutdown_core</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the core platform via the stop.sh scripts.&#39;</span><span class="p">)</span>
    
    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15|xargs kill -9 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;No such progress!&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Startup the core platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">startup_core</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the core platform via the startup.sh scripts.&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;Startup already!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;cd &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39; &amp;&amp; java -jar newark-core-platform-&#39;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&#39;.jar 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Restart the core platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">restart_core</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform via the restart.sh scripts.&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15|xargs kill -9 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;No such progress!&quot;</span><span class="p">)</span>

    <span class="n">ret_new</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep newark-core-platform|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret_new</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;Startup already!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;cd &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39; &amp;&amp; java -jar newark-core-platform-&#39;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&#39;.jar 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Shutdown the auth platform via the stop.sh scripts function.</span>

<span class="k">def</span> <span class="nf">shutdown_auth</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the auth platform via the stop.sh scripts.&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15|xargs kill -9 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;No such progress!&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Shutdown the auth platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Startup the auth platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">startup_auth</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the auth platform via the startup.sh scripts.&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;Startup already!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;cd &#39;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&#39; &amp;&amp; java -jar cmms-auth.jar 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Startup the authplatform finished!&#39;</span><span class="p">)</span>

<span class="c"># Restart the auth platform via the startup.sh scripts function.</span>
<span class="k">def</span> <span class="nf">restart_auth</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform via the restart.sh scripts.&#39;</span><span class="p">)</span>
    
    <span class="n">ret</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15|xargs kill -9 2&gt;/dev/null &gt;/dev/null&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&quot;No such progress!&quot;</span><span class="p">)</span>

    <span class="n">ret_new</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;ps -ef|grep cmms-auth|grep -v grep|cut -c 9-15&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ret_new</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;Startup already!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;warnings&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">),</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;cd &#39;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&#39; &amp;&amp; java -jar cmms-auth.jar 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Restart the core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Deploy core platform via mvn function.</span>
<span class="k">def</span> <span class="nf">deploy_core_platform</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy core platform via mvn.&#39;</span><span class="p">)</span>

    <span class="c"># Remove the old deploy dir</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rfv &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rfv &#39;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># Create necessary directory</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">svn_core_platform_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c"># Update the service address. Use the local ip address by default.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^service_addr=.*$/service_addr=http:\/\/&quot;</span><span class="o">+</span><span class="n">ip_addr</span><span class="o">+</span><span class="s">&quot;:8789\/auth\//g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the database url.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^url=.*$/url=jdbc:mysql:\/\/&quot;</span><span class="o">+</span><span class="n">db_addr</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">db_port</span><span class="o">+</span><span class="s">&quot;\/cmms_auth/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the database username.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^username=.*$/username=&quot;</span><span class="o">+</span><span class="n">db_usr</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the database password.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^password=.*$/password=&quot;</span><span class="o">+</span><span class="n">db_pwd</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the authentication server host.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^authentication_server_host_name=.*$/authentication_server_host_name=&quot;</span><span class="o">+</span><span class="n">ip_addr</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/osgi-util-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the memcached server ip.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^memcached_server_name=.*$/memcached_server_name=&quot;</span><span class="o">+</span><span class="n">memcached_ip</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/osgi-util-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the memcached server port.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^memcached_server_port=.*$/memcached_server_port=&quot;</span><span class="o">+</span><span class="n">memcached_port</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/osgi-util-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the memcached server ip.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^memcached_server_name=.*$/memcached_server_name=&quot;</span><span class="o">+</span><span class="n">memcached_ip</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the memcached server port.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^memcached_server_port=.*$/memcached_server_port=&quot;</span><span class="o">+</span><span class="n">memcached_port</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the bundles directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^platform\.bundles\.root\.dir=.*$/platform\.bundles\.root\.dir=&quot;</span><span class="o">+</span><span class="n">core_platform_bundles_path</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_path</span><span class="o">+</span><span class="s">&quot;/osgi-container.properties&quot;</span><span class="p">)</span>

    <span class="c"># Update the api service configuration.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/address=.*$/address=</span><span class="se">\&quot;</span><span class="s">http:\/\/&quot;</span><span class="o">+</span><span class="n">ip_addr</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">api_port</span><span class="o">+</span><span class="s">&quot;\/</span><span class="se">\&quot;</span><span class="s"> \&gt;/g&#39; &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/api-service.xml&quot;</span><span class="p">)</span>

    <span class="c"># Update the database configuration in the hibernate.cfg.xml.</span>
    <span class="c">#run(&quot;sed -i &#39;s/jdbc:mysql:\/\/.*$/jdbc:mysql:\/\/&quot;+db_addr+&quot;:&quot;+db_port+&quot;\/cmms\&lt;\/property\&gt;/g&#39; &quot;+svn_core_platform_dao_path+&quot;/hibernate.cfg.xml&quot;)</span>

    <span class="c"># Update the database configuration in the persistence.xml.</span>
    <span class="c">#run(&quot;sed -i &#39;s/jdbc:mysql:\/\/.*$/jdbc:mysql:\/\/&quot;+db_addr+&quot;:&quot;+db_port+&quot;\/cmms\&quot;\/\&gt;/g&#39; &quot;+svn_core_platform_dao_path+&quot;/META-INF/persistence.xml&quot;)</span>

    <span class="c"># Remove the end of configuration file. ^M mark.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/osgi-util-config.properties&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">svn_core_platform_config_path</span><span class="o">+</span><span class="s">&quot;/osgi-container.properties&quot;</span><span class="p">)</span>

    <span class="c"># Convert the configuration file.</span>
    <span class="c">#run(&quot;dos2unix &quot;+svn_core_platform_dao_path+&quot;/hibernate.cfg.xml&quot;)</span>
    <span class="c">#run(&quot;dos2unix &quot;+svn_core_platform_dao_path+&quot;/META-INF/persistence.xml&quot;)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">svn_core_platform_path</span><span class="p">):</span>
        <span class="c"># Print waiting info.</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;Please wait the deploy process until it automatically exit...&#39;</span><span class="p">)</span>
 
        <span class="c"># Install the necessary jar.</span>

        <span class="c"># Clear the core platform deploy log.</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;echo &quot;&quot; &gt; &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/core_deploy.log&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;mvn install:install-file -Dfile=&#39;</span><span class="o">+</span><span class="n">svn_core_platform_path</span><span class="o">+</span><span class="s">&#39;/lib/org.eclipse.osgi_3.10.0.v20140606-1445.jar -DgroupId=org.eclipse.osgi -DartifactId=org.eclipse.osgi -Dversion=3.10.0.v20140606 -Dclassifier=1445 -Dpackaging=jar &gt; &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/core_deploy.log&#39;</span><span class="p">)</span>

        <span class="n">run</span><span class="p">(</span><span class="s">&#39;mvn install:install-file -Dfile=&#39;</span><span class="o">+</span><span class="n">svn_core_platform_path</span><span class="o">+</span><span class="s">&#39;/lib/org.eclipse.osgi.services_3.4.0.v20140312-2051.jar -DgroupId=org.eclipse.osgi -DartifactId=org.eclipse.osgi.services -Dversion=3.4.0.v20140312 -Dclassifier=2051 -Dpackaging=jar &gt;&gt; &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/core_deploy.log&#39;</span><span class="p">)</span>

        <span class="c"># Pack the core platform use mvn command.</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;mvn clean install &gt;&gt; &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/core_deploy.log&#39;</span><span class="p">)</span>

        <span class="c"># Remove the useless directory.</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;classes&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;maven-archiver&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;maven-status&#39;</span><span class="p">)</span>
    
    <span class="c"># Copy the packed core platform to the deploy directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;cp -rv &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;* &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c"># Change the privileges of scripts. Make it executable.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;chmod +x &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;*.sh&#39;</span><span class="p">)</span>

    <span class="c"># Remove the auth directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rfv &quot;</span><span class="o">+</span><span class="n">core_platform_config_path</span><span class="o">+</span><span class="s">&quot;/auth&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Congratulations! Deploy core platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Deploy auth platform via mvn.</span>
<span class="k">def</span> <span class="nf">deploy_auth_platform</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy auth platform via mvn.&#39;</span><span class="p">)</span>

    <span class="c"># Create necessary directory</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c"># Copy the packed core platform to the deploy directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cp -r &quot;</span><span class="o">+</span><span class="n">svn_core_platform_target_path</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="s">&quot;* &quot;</span><span class="o">+</span><span class="n">auth_path</span><span class="p">)</span>

    <span class="c"># Change the privileges of scripts. Make it executable.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;chmod +x &quot;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="s">&quot;*.sh&quot;</span><span class="p">)</span>
    
    <span class="c"># Update the bundels dir</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/^platform\.bundles\.root\.dir=.*$/platform\.bundles\.root\.dir=&quot;</span><span class="o">+</span><span class="n">auth_platform_bundles_path</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">auth_platform_config_path</span><span class="o">+</span><span class="s">&quot;/osgi-container.properties&quot;</span><span class="p">)</span>

    <span class="c"># Remove the busi directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rf &quot;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&quot;/bundles/busi&quot;</span><span class="p">)</span>

    <span class="c"># Rename the jar.</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">auth_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;./rename.sh &#39;</span><span class="o">+</span><span class="n">core_platform_jar</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">auth_platform_jar</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># Optimize the stop scripts</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/&quot;</span><span class="o">+</span><span class="n">core_jar</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">auth_jar</span><span class="o">+</span><span class="s">&quot;/g&#39; &quot;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&quot;/stop.sh&quot;</span><span class="p">)</span>

    <span class="c"># Remove the end of configuration file. ^M mark.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">auth_platform_config_auth_path</span><span class="o">+</span><span class="s">&quot;/osgi-auth-config.properties&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">auth_platform_config_api_path</span><span class="o">+</span><span class="s">&quot;/osgi-util-config.properties&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix &quot;</span><span class="o">+</span><span class="n">auth_platform_config_path</span><span class="o">+</span><span class="s">&quot;/osgi-container.properties&quot;</span><span class="p">)</span>

    <span class="c"># Remove the api directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rf &quot;</span><span class="o">+</span><span class="n">auth_platform_config_path</span><span class="o">+</span><span class="s">&quot;/api&quot;</span><span class="p">)</span>

    <span class="c"># Remove the newarkstg-osgi-auth_version.jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&#39;/bundles/platform/newarkstg-osgi-auth_&#39;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&#39;.jar&#39;</span><span class="p">)</span>

    <span class="c"># Remove the newarkstg-osgi-util_version.jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">auth_path</span><span class="o">+</span><span class="s">&#39;/bundles/platform/newark-osgi-util_&#39;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&#39;.jar&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Congratulations! Deploy auth platform finished!&#39;</span><span class="p">)</span>

<span class="c"># Update the database setting function.</span>
<span class="k">def</span> <span class="nf">update_database_setting</span><span class="p">():</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Update the database setting.&#39;</span><span class="p">)</span>
    <span class="c"># Create the temp dir.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p ~/temp 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c"># Copy the dao jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cp -v &quot;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&quot;/bundles/busi/service_impl/com.newarkstg.cmms.dao_&quot;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&quot;.jar ~/temp&quot;</span><span class="p">)</span>

    <span class="c"># Unzip the dao jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd ~/temp &amp;&amp; jar xvf ~/temp/com.newarkstg.cmms.dao_&quot;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&quot;.jar&quot;</span><span class="p">)</span>

    <span class="c"># Update the database configuration in the hibernate.cfg.xml.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/jdbc:mysql:\/\/.*$/jdbc:mysql:\/\/&quot;</span><span class="o">+</span><span class="n">db_addr</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">db_port</span><span class="o">+</span><span class="s">&quot;\/cmms\&lt;\/property\&gt;/g&#39; ~/temp/hibernate.cfg.xml&quot;</span><span class="p">)</span>

    <span class="c"># Update the database configuration in the persistence.xml.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;sed -i &#39;s/jdbc:mysql:\/\/.*$/jdbc:mysql:\/\/&quot;</span><span class="o">+</span><span class="n">db_addr</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">db_port</span><span class="o">+</span><span class="s">&quot;\/cmms</span><span class="se">\&quot;</span><span class="s">\/\&gt;/g&#39; ~/temp/META-INF/persistence.xml&quot;</span><span class="p">)</span>

    <span class="c"># Remove the old jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rf ~/temp/com.newarkstg.cmms.dao_&quot;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&quot;.jar&quot;</span><span class="p">)</span>

    <span class="c"># Convert the configuration file.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix ~/temp/hibernate.cfg.xml&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;dos2unix ~/temp/META-INF/persistence.xml&quot;</span><span class="p">)</span>

    <span class="c"># Create the dao jar.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd ~/temp &amp;&amp; jar cvfM com.newarkstg.cmms.dao_&quot;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&quot;.jar com hibernate.cfg.xml META-INF&quot;</span><span class="p">)</span>

    <span class="c"># Copy the jar to the core platform.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cp -v ~/temp/com.newarkstg.cmms.dao_&quot;</span><span class="o">+</span><span class="n">core_version</span><span class="o">+</span><span class="s">&quot;.jar&quot;</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">core_platform_path</span><span class="o">+</span><span class="s">&quot;/bundles/busi/service_impl&quot;</span><span class="p">)</span>

    <span class="c"># Remove the temp directory.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rfv ~/temp&quot;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Update the database setting finished!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">deploy_prepare</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy prepared. Run as root.&#39;</span><span class="p">)</span>
    
    <span class="c"># Install jdk 1.8.25.</span>
    <span class="k">print</span> <span class="n">red</span><span class="p">(</span><span class="s">&#39;This program require jdk 1.8.25. Make sure jdk and tomcat work out before all of your operations.&#39;</span><span class="p">)</span>

    <span class="c"># Install maven.</span>
    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Insall maven.&#39;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;wget http://apache.fayea.com/apache-mirror/maven/maven-3/3.2.3/binaries/apache-maven-3.2.3-bin.zip&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;unzip -q apache-maven-3.2.3-bin.zip&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;mv apache-maven-3.2.3 /usr/local/maven&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;echo &#39;export M2_HOME=/usr/local/maven&#39; &gt;&gt; /etc/profile&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;echo &#39;export PATH=$PATH:$M2_HOME/bin&#39; &gt;&gt; /etc/profile&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;source /etc/profile&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;rm -rf apache-maven-3.2.3-bin.zip apache-maven-3.2.3&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;mvn -version&quot;</span><span class="p">)</span>
    
    <span class="n">log_path</span><span class="o">=</span><span class="s">&#39;~/logs&#39;</span>
    
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39; 2&gt;/dev/null &gt;/dev/null&#39;</span><span class="p">)</span>

    <span class="c"># Clear the install_requirement.log</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;echo &quot;&quot; &gt; &#39;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&#39;/install_requirement.log&#39;</span><span class="p">)</span>

    <span class="c"># Install Python and fabric on the remote server.</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;apt-get install dos2unix python python-pip python-dev subversion subversion-tools -y &gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/install_requirement.log&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;pip install fabric &gt;&gt; &quot;</span><span class="o">+</span><span class="n">log_path</span><span class="o">+</span><span class="s">&quot;/install_requirement.log&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">green</span><span class="p">(</span><span class="s">&#39;Deploy prepared finished.&#39;</span><span class="p">)</span></code></pre></div>

<h3 id="section-8">5.4 配置文件概述</h3>

<p>完整配置文件内容如下：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Database config section.</span>
<span class="o">[</span>database<span class="o">]</span>
<span class="c"># Database address.</span>
<span class="nv">db_addr</span><span class="o">=</span>
<span class="c"># Database port.</span>
<span class="nv">db_port</span><span class="o">=</span>
<span class="c"># Database username.</span>
<span class="nv">db_usr</span><span class="o">=</span>
<span class="c"># Datbase password.</span>
<span class="nv">db_pwd</span><span class="o">=</span>

<span class="c"># Remote server section.</span>
<span class="o">[</span>remote<span class="o">]</span>
<span class="c"># Remote server ip.</span>
<span class="nv">remote_ip</span><span class="o">=</span>
<span class="c"># Remote server port.</span>
<span class="nv">remote_port</span><span class="o">=</span>
<span class="c"># Remote server username.</span>
<span class="nv">remote_usr</span><span class="o">=</span>
<span class="c"># Remote server password.</span>
<span class="nv">remote_pwd</span><span class="o">=</span>

<span class="c"># SVN path section.</span>
<span class="o">[</span>svn_path<span class="o">]</span>
<span class="c"># Svn main directory of newarkstg repo.</span>
<span class="nv">svn_ns_dir</span><span class="o">=</span>
<span class="c"># Svn core platform path.</span>
<span class="nv">svn_core_platform_path</span><span class="o">=</span>
<span class="c"># Svn core platform path config path</span>
<span class="nv">svn_core_platform_config_path</span><span class="o">=</span>
<span class="c"># Svn core platform path config auth path</span>
<span class="nv">svn_core_platform_config_auth_path</span><span class="o">=</span>
<span class="c"># Svn core platform path config api path</span>
<span class="nv">svn_core_platform_config_api_path</span><span class="o">=</span>
<span class="c"># Svn core platform dao path</span>
<span class="nv">svn_core_platform_dao_path</span><span class="o">=</span>
<span class="c"># Svn core platform target path.</span>
<span class="nv">svn_core_platform_target_path</span><span class="o">=</span>

<span class="c"># SVN configuration section. </span>
<span class="o">[</span>svn<span class="o">]</span>
<span class="nv">svn_username</span><span class="o">=</span>
<span class="nv">svn_password</span><span class="o">=</span>
<span class="nv">svn_url</span><span class="o">=</span>

<span class="c"># Core platform path config section.</span>
<span class="o">[</span>core_path<span class="o">]</span>
<span class="c"># Core platform path.</span>
<span class="nv">core_platform_path</span><span class="o">=</span>
<span class="c"># Core platform config path.</span>
<span class="nv">core_platform_config_path</span><span class="o">=</span>
<span class="c"># Core platform config api path</span>
<span class="nv">core_platform_config_api_path</span><span class="o">=</span>
<span class="c"># Core platform config auth path</span>
<span class="nv">core_platform_config_auth_path</span><span class="o">=</span>
<span class="c"># Core platform bundles path</span>
<span class="nv">core_platform_bundles_path</span><span class="o">=</span>

<span class="c"># Auth platform path config section.</span>
<span class="o">[</span>auth_path<span class="o">]</span>
<span class="c"># Auth platform path.</span>
<span class="nv">auth_path</span><span class="o">=</span>
<span class="c"># Auth platform configuration path.</span>
<span class="nv">auth_platform_config_path</span><span class="o">=</span>
<span class="c"># Auth platform configuration api path.</span>
<span class="nv">auth_platform_config_api_path</span><span class="o">=</span>
<span class="c"># Auth platform configuration auth path.</span>
<span class="nv">auth_platform_config_auth_path</span><span class="o">=</span>
<span class="c"># Authplatform bundles path</span>
<span class="nv">auth_platform_bundles_path</span><span class="o">=</span>

<span class="c"># Memcached configuration section.</span>
<span class="o">[</span>memcached<span class="o">]</span>
<span class="c"># Memcached server ip.</span>
<span class="nv">memcached_ip</span><span class="o">=</span>
<span class="c"># Memcached server port.</span>
<span class="nv">memcached_port</span><span class="o">=</span>

<span class="c"># Other configuration section</span>
<span class="o">[</span>other<span class="o">]</span>
<span class="c"># Core platform version.</span>
<span class="nv">core_version</span><span class="o">=</span>
<span class="c"># Remote log path</span>
<span class="nv">remote_log_path</span><span class="o">=</span>
<span class="c"># Api port</span>
<span class="nv">api_port</span><span class="o">=</span>
<span class="c"># Core platform jar name</span>
<span class="nv">core_platform_jar</span><span class="o">=</span>
<span class="c"># Auth platform jar name</span>
<span class="nv">auth_platform_jar</span><span class="o">=</span>
<span class="c"># Core jar</span>
<span class="nv">core_jar</span><span class="o">=</span>
<span class="c"># Auth jar</span>
<span class="nv">auth_jar</span><span class="o">=</span></code></pre></div>

<p>接下来，我逐一进行讲解。</p>

<p>配置文件包括以下段：database、remote、svn_path、svn、core_path、auth_path、memcached和other。</p>

<p>每个段的说明如下：</p>

<ul>
  <li>database 该段定义数据库配置。
    <ul>
      <li>db_addr MySQL数据库地址。</li>
      <li>db_usr MySQL数据库用户名。</li>
      <li>db_pwd MySQL数据库密码。</li>
      <li>db_port MySQL数据库端口，默认为3306。</li>
    </ul>
  </li>
  <li>remote 该段定义远程服务器登录信息。
    <ul>
      <li>remote_ip 部署远程服务器IP。</li>
      <li>remote_port 部署远程服务器端口。</li>
      <li>remote_usr 部署远程服务器用户名。</li>
      <li>remote_pwd 部署远程服务器密码。</li>
    </ul>
  </li>
  <li>svn_path 该段定义远程服务器SVN目录。
    <ul>
      <li>svn_ns_dir 项目主SVN目录。</li>
      <li>svn_core_platform_path 业务平台SVN目录。</li>
      <li>svn_core_platform_config_path 业务平台主配置文件目录。</li>
      <li>svn_core_platform_config_auth_path 业务平台AUTH配置文件目录。</li>
      <li>svn_core_platform_config_api_path 业务平台API配置文件目录。</li>
      <li>svn_core_platform_dao_path 业务平台DAO目录。</li>
      <li>svn_core_platform_target_path 业务平台Target目录，用于存放打包后的文件。</li>
    </ul>
  </li>
  <li>svn 该段定义SVN的账户信息。
    <ul>
      <li>svn_username SVN用户名。</li>
      <li>svn_password SVN密码。</li>
      <li>svn_url SVN地址。</li>
    </ul>
  </li>
  <li>core_path 该段定义部署后的业务平台目录。
    <ul>
      <li>core_platform_path 业务平台主目录。</li>
      <li>core_platform_config_path 业务平台配置文件目录。</li>
      <li>core_platform_config_api_path 业务平台API配置文件目录。</li>
      <li>core_platform_config_auth_path 业务平台AUTH配置文件目录。</li>
      <li>core_platform_bundles_path 业务平台Bundles目录。</li>
    </ul>
  </li>
  <li>auth_path 该段定义部署后的认证平台目录。
    <ul>
      <li>auth_path 认证平台主目录。</li>
      <li>auth_platform_config_path 认证平台配置文件目录。</li>
      <li>auth_platform_config_api_path 认证平台API配置文件目录。</li>
      <li>auth_platform_config_auth_path 认证平台AUTH配置文件目录。</li>
      <li>auth_platform_bundles_path 认证平台Bundles目录。</li>
    </ul>
  </li>
  <li>memcached 该段定义Memcached相关信息。
    <ul>
      <li>memcached_ip Memcached服务器IP。</li>
      <li>memcached_port Memcached服务器端口。</li>
    </ul>
  </li>
  <li>other 该段定义其他配置信息。
    <ul>
      <li>core_version 业务平台版本号。</li>
      <li>remote_log_path 远程服务器日志文件目录，用于存放部署业务平台产生的日志。</li>
      <li>api_port 业务平台的API端口。</li>
      <li>core_platform_jar 打包生成的业务平台jar包，完整文件名。</li>
      <li>auth_platform_jar 认证平台jar包，完整文件名。</li>
      <li>core_jar 业务平台jar包，不带后缀。</li>
      <li>auth_jar 认证平台jar包，不带后缀。</li>
    </ul>
  </li>
</ul>

<p><strong>注：以上是所有的配置项，请酌情修改。</strong></p>

<h2 id="section-9">6.脚本使用</h2>

<p>如果您是第一次使用该脚本打包，请依次执行如下命令：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># 第一步，编辑配置文件；</span>
vim config.conf

<span class="c"># 第二步，显示帮助；</span>
./auto_deploy_app_remote.py -h

<span class="c"># 第三步，准备部署（此步可以略过，因为环境已经搭建好）；</span>
./auto_deploy_app_remote.py -p

<span class="c"># 第四步，检出项目；</span>
./auto_deploy_app_remote.py -c

<span class="c"># 第五步，部署业务平台；</span>
./auto_deploy_app_remote.py -d

<span class="c"># 第六步，部署认证平台；</span>
./auto_deploy_app_remote.py -w

<span class="c"># 第七步，修改数据库配置；</span>
./auto_deploy_app_remote.py -x

<span class="c"># 第八步，启动认证平台</span>
./auto_deploy_app_remote.py -k

<span class="c"># 第九布，启动业务平台</span>
./auto_deploy_app_remote.py -t</code></pre></div>

<p><strong>注：第八步可以使用「./auto_deploy_app_remote.py -g」代替，第九步可以使用「./auto_deploy_app_remote.py -r」代替。</strong></p>

<p>如果您是使用该脚本更新项目，请依次执行如下命令：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># 第一步，如有需要，编辑配置文件；</span>
vim config.conf

<span class="c"># 第二步，显示帮助；</span>
./auto_deploy_app_remote.py -h

<span class="c"># 第三步，更新项目；</span>
./auto_deploy_app_remote.py -u

<span class="c"># 第四步，关闭认证平台；</span>
./auto_deploy_app_remote.py -a

<span class="c"># 第五步，关闭业务平台</span>
./auto_deploy_app_remote.py -s

<span class="c"># 第六步，部署业务平台；</span>
./auto_deploy_app_remote.py -d

<span class="c"># 第七步，部署认证平台；</span>
./auto_deploy_app_remote.py -w

<span class="c"># 第八步，修改数据库配置；</span>
./auto_deploy_app_remote.py -x

<span class="c"># 第九步，启动认证平台</span>
./auto_deploy_app_remote.py -k

<span class="c"># 第十布，启动业务平台</span>
./auto_deploy_app_remote.py -t</code></pre></div>

<p><strong>注：第九步可以使用「./auto_deploy_app_remote.py -g」代替，第十步可以使用「./auto_deploy_app_remote.py -r」代替。</strong></p>

<p>Enjoy！</p>

<h2 id="github">7.GitHub地址</h2>

<p>python-auto-deploy：<a href="https://github.com/dbarobin/python-auto-deploy" target="_blank">https://github.com/dbarobin/python-auto-deploy</a></p>

<h2 id="section-10">8.项目说明</h2>
<p>auto_deploy_app_v2: 适用于Linux。<br />
auto_deploy_app_windows: 适用于Windows。</p>

<p>–EOF–</p>

<p>版权声明：自由转载-非商用-非衍生-保持署名<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">（创意共享3.0许可证）</a></p>

<h2 id="section-11">9.作者信息</h2>

<p>温国兵</p>

<ul>
  <li>Robin Wen</li>
  <li><a href="mailto:dbarobinwen@gmail.com"><img src="http://i.imgur.com/7yOaC7C.png" title="Robin's Gmail" border="0" height="16px" width="16px" alt="Robin's Gmail" /></a></li>
  <li><a href="https://github.com/dbarobin" target="_blank"><i class="fa fa-github"></i></a></li>
  <li><a href="http://dbarobin.com/" target="_blank"><img src="http://i.imgur.com/dEfMkyt.jpg" title="Robin's Blog" border="0" alt="Robin's Blog" height="16px" width="16px" /></a></li>
  <li><a href="http://blog.csdn.net/justdb" target="_blank"><img src="http://i.imgur.com/BROigUO.jpg" title="DBA@Robin's CSDN" height="16px" width="16px" border="0" alt="DBA@Robin's CSDN" /></a></li>
</ul>

  </article>
  <hr />

</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/2014/11/29/piano-concert-of-shijin-in-guangzhou/" title="石进-广州钢琴作品音乐会">&larr; Older</a></li>
    
    
    <li class="next"><a href="/2014/12/07/recommendation-on-mysql-cluster/" title="MySQL集群建议">Newer &rarr;</a></li>
    
  </ul>
</section>

<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='dbarobin';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>


  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Robin Wen" src="/images/wentasy.png" alt="Robin Wen"/>

  <span>Robin Wen, MySQL DBA.</span>
  <br />

  WeChat: dbtalk
  <br />

  

  You can contact me via:

  
  <a href="mailto:dbarobinwen@gmail.com" title="mailto: dbarobinwen@gmail.com" target="_blank">Email</a> /
  
  
  <a href="https://github.com/dbarobin" title="GithubID: dbarobin" target="_blank">GitHub</a> /
  
  
  <a href="https://twitter.com/dbarobin" title="TwitterID: dbarobin" target="_blank">Twitter</a>
  

  

</div>

<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">
    <img alt="Copyright Notice" src="http://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Attribution-NonCommercial-NoDerivs</a>

  

</div>

<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="http://dbarobin.com/2015/04/07/mydumper/" title="mydumper 完全参考手册" rel="bookmark">mydumper 完全参考手册</a>
  </li>
  
  <li>
  <a href="http://dbarobin.com/2015/03/23/opensource-innovation-meetup-in-shenzhen/" title="开源中国深圳源创会分享" rel="bookmark">开源中国深圳源创会分享</a>
  </li>
  
  <li>
  <a href="http://dbarobin.com/2015/03/16/the-first-diary-of-website-optimization/" title="网站优化日记（一）" rel="bookmark">网站优化日记（一）</a>
  </li>
  
  <li>
  <a href="http://dbarobin.com/2015/03/08/lucky-money-of-wechat-and-alipay/" title="我看微信红包和支付宝红包" rel="bookmark">我看微信红包和支付宝红包</a>
  </li>
  
  <li>
  <a href="http://dbarobin.com/2015/02/28/sql-query-once-and-ten-times/" title="MySQL 每次查询一条数据查询十次与一次查询十条数据之间的区别" rel="bookmark">MySQL 每次查询一条数据查询十次与一次查询十条数据之间的区别</a>
  </li>
  
</div>

<div class="sidebar-module">
  <h4>Categories</h4>
  
  <li><a href="/categories/#other" title="other" rel="92">Other (92)</a></li>
  
  <li><a href="/categories/#linux" title="linux" rel="3">Linux (3)</a></li>
  
  <li><a href="/categories/#mysql" title="mysql" rel="28">Mysql (28)</a></li>
  
  <li><a href="/categories/#python" title="python" rel="2">Python (2)</a></li>
  
</div>


<div class="sidebar-module">
  <h4>Blogroll</h4>
  
  <li><a href="http://blog.csdn.net/dba_waterbin" title="DBA@DevOps" target="_blank">DBA@DevOps</a></li>
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2015" > <a href="/archives/#2015">2015</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>


  

  <footer class="site-footer">
  <link rel="stylesheet" type="text/css" href="/assets/css/robin.css">
  <p> &copy; 2015 Robin Wen. All Rights Reserved.</p>
   <div id="totop" class="mytotop">
      <a title="Back To Top"><img alt="Scrollup to home page of dbarobin.com" src="/images/scrollup.png"/></a>
   </div>

<script type="text/javascript" defer="defer" src="/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript" defer="defer" src="//dn-lbstatics.qbox.me/lbservice/busuanzi/1.0/busuanzi.mini.js"/></script>
<script type="text/javascript" defer="defer" src="/assets/js/totop.js"></script>
</footer>


</div>

</body>

</html>
